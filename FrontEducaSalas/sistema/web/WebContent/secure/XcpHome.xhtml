<?xml version="1.0" encoding="ISO-8859-1" ?>
<ui:composition
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:xcp="http://www.xcapesoftware.com.br/xcp_tags"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	template="#{xcp:getLayout(xcpLayoutAppBacking.tipoAcesso == 2 ? 'nportal': 'manut')}">

	<ui:define name="conteudo">

		<p:outputPanel rendered="#{xcpLayoutAppBacking.tipoAcesso == 2}">
			<ui:include src="/secure/XcpHome/DashboardPortalForm.xhtml"  />
		</p:outputPanel>

		<xcp:panelContent>
			<ui:define name="headerEject" />

			<p:outputPanel rendered="#{xcpSessionBacking.tipJanela == 4}">
				<p:remoteCommand
					name="cmdXcpMultiDialogCtrlOpen"
					action="#{xcpMultiDialogCtrlBacking.actionOpenNewDialog}"
					update=":xcpMultiDialogCtrlContainer,xcpMultiDialogCtrlTaskBar" />

				<p:remoteCommand
					name="cmdXcpMultiDialogCtrlClose"
					action="#{xcpMultiDialogCtrlBacking.actionClose}"
					update="xcpMultiDialogCtrlTaskBar" />

				<p:remoteCommand
					name="cmdXcpMultiDialogCtrlCloseAll"
					action="#{xcpMultiDialogCtrlBacking.actionCloseAll}"
					update="xcpMultiDialogCtrlTaskBar" />

				<p:remoteCommand
					name="cmdXcpMultiDialogCtrlCloseOthers"
					action="#{xcpMultiDialogCtrlBacking.actionCloseOthers}"
					update="xcpMultiDialogCtrlTaskBar" />

				<script type="text/javascript">
					var xcpMultiDlgWVars = [];
					var xcpMultiDlgMinimized = [];

					function removeByValue(arr, val) {
						for(var i=0; i &lt; arr.length; i++) {
							if(arr[i] == val) {
								arr.splice(i, 1);
								break;
							}
						}
					}
					
					function xcpMultiDlgHandleNewDialog(_widgetVar) {
						 w_dlgvar = PF(_widgetVar);
						 w_dlgvar.getJQ().appendTo("#xcpMultiDialogCtrlContainerDest");

						 w_dlgvar.toggleMinimize = xcpMultiDlgMinimizeDialog;

						 w_dlgvar.show();
						 xcpMultiDlgWVars.push(_widgetVar);
					}

					function xcpMultiDlgCloseDialog(_dlgId, _widgetVar) {
						if (xcpMultiDlgMinimized.indexOf(_widgetVar) &lt; 0) {
							cmdXcpMultiDialogCtrlClose([ {
								name : 'xcp_dlg_id',
								value : _dlgId
							} ]);
						}
					}

					function xcpMultiDlgMinimizeDialog() {
						xcpMultiDlgMinimized.push(this.widgetVar);
						PF(this.widgetVar).hide();
					}

					function xcpMultiDlgTaskBarClick(_widgetVar) {
						w_dlgvar = PF(_widgetVar);
						w_dlgvar.show();
						w_dlgvar.moveToTop();

						removeByValue(xcpMultiDlgMinimized, _widgetVar);
					}

					function xcpMultiDlgTaskBarClose(_dlgId, _widgetVar) {
						if (xcpMultiDlgMinimized.indexOf(_widgetVar) &lt; 0) {
							//Se nao esta minimizada, fecha
							PF(_widgetVar).hide();
						} else {
							removeByValue(xcpMultiDlgMinimized, _widgetVar);
							//Se esta minimizada executa o command para tirar da barra
							cmdXcpMultiDialogCtrlClose([ {
								name : 'xcp_dlg_id',
								value : _dlgId
							} ]);
						}
					}
					
					function xcpMultiDlgTaskBarCloseAll() {
						//coloca todas como minimizada para nao executar o comand do close
						xcpMultiDlgMinimized = xcpMultiDlgWVars;
						for (index = 0; index &lt; xcpMultiDlgWVars.length; ++index) {
							PF(xcpMultiDlgWVars[index]).hide();
						}
						xcpMultiDlgMinimized = [];
						xcpMultiDlgWVars = [];
						//Executa o comando close all
						cmdXcpMultiDialogCtrlCloseAll();
					}

					function xcpMultiDlgTaskBarCloseOthers(_dlgId, _widgetVar) {
						var isMinimized = xcpMultiDlgMinimized.indexOf(_widgetVar) &lt; 0;
						//coloca todas como minimizada para nao executar o comand do close
						xcpMultiDlgMinimized = xcpMultiDlgWVars;
						for (index = 0; index &lt; xcpMultiDlgWVars.length; ++index) {
							if(xcpMultiDlgWVars[index] != _widgetVar) {
								PF(xcpMultiDlgWVars[index]).hide();
							}
						}
						xcpMultiDlgWVars = [_widgetVar];
						if (isMinimized) {
							xcpMultiDlgMinimized = [_widgetVar];
						} else {
							xcpMultiDlgMinimized = [];
						}		
						//Executa o comando close all
						cmdXcpMultiDialogCtrlCloseOthers([ {
							name : 'xcp_dlg_id',
							value : _dlgId
						} ]);
					}
					
				</script>

				<p:toolbar id="xcpMultiDialogCtrlTaskBar">
					<f:facet name="left">
						<p:spacer
							height="21"
							rendered="#{empty xcpMultiDialogCtrlBacking.openedDialogs}" />

						<c:forEach
							items="#{xcpMultiDialogCtrlBacking.openedDialogs}"
							var="dlg"
							varStatus="vs">

							<p:commandButton
								id="btnTaskBar_#{vs.index}"
								type="button"
								value="#{dlg.name}"
								onclick="xcpMultiDlgTaskBarClick('#{dlg.widgetVar}');" />

							<p:contextMenu
								id="mnuTaskBar_#{vs.index}"
								for="btnTaskBar_#{vs.index}">
								<p:menuitem
									id="mnuTaskBarClose_#{vs.index}"
									value="#{bundle.mnu_fechar}"
									url="javascript:void(0)"
									onclick="xcpMultiDlgTaskBarClose('#{dlg.id}', '#{dlg.widgetVar}');"
									icon="ui-icon-close" />

								<p:menuitem
									value="#{bundle.mnu_fecharOutras}"
									url="javascript:void(0)"
									onclick="xcpMultiDlgTaskBarCloseOthers('#{dlg.id}', '#{dlg.widgetVar}')"
									icon="ui-icon-close" />

								<p:menuitem
									value="#{bundle.mnu_fecharTodas}"
									url="javascript:void(0)"
									onclick="xcpMultiDlgTaskBarCloseAll()"
									icon="ui-icon-close" />
							</p:contextMenu>

						</c:forEach>

					</f:facet>

					<f:facet name="right">
						<xcp:commandButton
							id="btnTaskBarFecharTodas"
							type="button"
							icon="ui-icon-close"
							onclick="xcpMultiDlgTaskBarCloseAll()"
							rendered="#{not empty xcpMultiDialogCtrlBacking.openedDialogs}" />
					</f:facet>

				</p:toolbar>
			</p:outputPanel>
		</xcp:panelContent>

	</ui:define>

	<ui:define name="modalPanelArea">

		<div id="xcpMultiDialogCtrlContainerDest"></div>

		<h:panelGroup id="xcpMultiDialogCtrlContainer">
			<p:dialog
				id="#{xcpMultiDialogCtrlBacking.nextDialog.id}"
				widgetVar="#{xcpMultiDialogCtrlBacking.nextDialog.widgetVar}"
				height="450"
				width="850"
				header="#{xcpMultiDialogCtrlBacking.nextDialog.name}"
				maximizable="true"
				minimizable="true"
				styleClass="xcp_multi_dialog">

				<p:ajax
					event="close"
					onstart="xcpMultiDlgCloseDialog('#{xcpMultiDialogCtrlBacking.nextDialog.id}','#{xcpMultiDialogCtrlBacking.nextDialog.widgetVar}'); return false;"
					process="@none"
					update="@none" />

				<p:ajax
					event="maximize"
					onstart="PF('#{xcpMultiDialogCtrlBacking.nextDialog.widgetVar}').content.css('height','100%'); return false;"
					process="@none"
					update="@none" />

				<iframe
					src="#{xcpMultiDialogCtrlBacking.nextDialog.url}"
					width="100%"
					height="100%"
					style="border: none;" />
			</p:dialog>
		</h:panelGroup>

	</ui:define>
</ui:composition>